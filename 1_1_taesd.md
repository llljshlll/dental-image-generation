# TAESD Integration Attempt in ctrLoRA 

---

## 1) 배경과 목적
- **배경**: ctrLoRA 파이프라인은 기본적으로 **SD VAE**를 사용. 인·디코딩(입·출력) 구간이 실시간성 병목이 될 수 있음.
- **목적**: **TAESD(Tiny AutoEncoder for SD)** 를 적용해 인·디코딩 지연을 줄이고, 전체 latency < 1s 목표를 더 넉넉히 달성할 수 있는지 검증.

---

## 2) 적용 과정
- **구성 교체**: `configs/*`의 `encoder`, `decoder` 항목을 **`autoencoder.py` → `taesd.py`**로 교체  
  - Encoder: `TAESDEncoder`, Decoder: `TAESDDecoder`  
  - 공개된 **TAESD 체크포인트** 사용(커스텀 학습 X)
- **정규화 정합화**: **SD-UNet**과 **TAESD**의 기대 스케일 불일치 해결
  - 입력 스케일: `[0,1] → [-1,1]`로 변환 후 **TAESD Encoder**  
  - 출력 스케일: **TAESD Decoder** 결과 `[-1,1] → [0,1]` 복원  
  - UNet 입력 전 분포(평균/분산) 확인 → **정규화 mismatch 해결됨**
- **중요**: 정규화 문제는 **최종 품질 저하의 원인이 아님**. 분포를 맞춘 후엔 출력 일관성 양호.

---

## 3) 실험 결과(요약)
- **초기 검증(load data)**: 도메인 외 공개 데이터로 **기능 검증 성공**(속도 이점 확인).
- **치아 도메인 데이터 재검증**:  
  - **문제**: 치아 경계/에나멜 질감이 **VAE 대비 흐림(blur)**, 잇몸과 치아 간 **bleed-in** 증가, 반사 하이라이트 표현 약화.  
  - **관찰**: 구조적 세부(곡률, 치경부 경계)에서 **flattening** 경향.

> 결론적으로, **정규화는 원인이 아니었고**, **TAESD 모델 자체의 도메인 복원력 부족**이 주된 원인이었음.

---

## 4) Decision
> **VAE 유지**  
- **사유 1 – 품질**: 치아/잇몸 경계·에나멜 질감 등 **고주파 디테일**에서 **VAE > TAESD**.  
- **사유 2 – 적응 불가**: **TAESD 학습 코드 미공개**로 **도메인 재학습/미세조정 불가** → 품질 개선 경로 차단.  
- **사유 3 – 속도 요건 충족**: VAE 사용 시에도 **end-to-end < 1s** 달성(LCM 등 별도 최적화로 보완).

---

## 5) 근거(정성/정량 제안)
- **정성 비교**(이미지): 동일 케이스에서 `VAE ↔ TAESD` 결과를 **동일 크롭/스케일/압축**으로 비교  
  - 폴더: `images/taesd_vs_vae/`
  - 캡션 예: `case1_zoom_tooth_boundary.png` – VAE 선명 / TAESD 경계 흐림
- **정량 지표**(권장):  
  - **경계 Dice / 경계 F1** (치아 마스크 기준)  
  - **HF Energy(고주파 성분)**, **SSIM(구조 일치)**  
  - 기준: VAE 대비 유의한 하락 시 TAESD 불채택

---

## 6) Implementation Notes
- **YAML 교체**  
  - `model.encoder: taesd.TAESDEncoder`  
  - `model.decoder: taesd.TAESDDecoder`
- **스케일 변환**  
  - Encoder 입력: `img_01 → img_m11 = img_01 * 2 - 1`  
  - Decoder 출력: `out_01 = (out_m11 + 1) / 2`  
- **UNet 입력 분포**  
  - 정규화/채널 순서 점검 후 **mismatch 없음** 확인(문제 원인 제거)  
- **체크포인트**  
  - 공개 TAESD 가중치 그대로 사용(학습/튜닝 X)

---

## 7) 한계와 회고
- **한계**: TAESD는 경량화 설계로 **일반 이미지**에선 유리하나, **고주파 디테일이 중요한 치아 도메인**에서는 복원력이 부족.  
- **회고**: 만약 TAESD 학습 코드가 공개되거나, 도메인별 재학습이 가능했다면 **품질 격차**를 줄일 여지가 있었음.  
- **대안**: 향후 경량 VAE를 **도메인 재학습**하거나, 하이브리드(예: TAESD 인코더 + VAE 디코더) 탐색 가능.

---

## 요약
- **정규화 mismatch?** → ✅ **해결됨** (원인 아님)  
- **도메인 품질?** → ❌ TAESD가 **치아 디테일 보존에서 열세**  
- **학습 코드?** → ❌ 미공개, 도메인 적응 불가  
- **결론** → **VAE 유지**, 실시간성은 **스케줄러/파이프라인 최적화**로 확보

